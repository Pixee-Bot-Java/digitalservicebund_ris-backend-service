name: Bump chainguard digests

on:
  # schedule:
  #   - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  update-digests:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write # Enable OIDC for gitsign
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Pull latest images
        run: |
          docker pull cgr.dev/chainguard/nginx:latest
          docker pull cgr.dev/chainguard/redis:latest
      - name: Get newest digests
        run: |
          NGINX_DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' cgr.dev/chainguard/nginx:latest)
          REDIS_DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' cgr.dev/chainguard/redis:latest)
          echo "NGINX_DIGEST=$NGINX_DIGEST" >> $GITHUB_ENV
          echo "REDIS_DIGEST=$REDIS_DIGEST" >> $GITHUB_ENV
      - name: Update digests in the repository
        run: |
          sed -i "s|nginx@.*|$NGINX_DIGEST|g" frontend/Dockerfile.prod
          sed -i "s|redis@.*|$REDIS_DIGEST|g" compose.yaml
      - uses: chainguard-dev/actions/setup-gitsign@ac42db4c9c2e2bd9f66aadf3290c5995891d91a3
      - name: Commit and push changes
        run: |
          git add frontend/Dockerfile.prod
          git add compose.yaml
          git diff-index --cached --quiet HEAD ||
            git commit -m "Bump chainguard images" &&
            git push origin main
